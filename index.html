<!DOCTYPE html>
<html lang="en">
	<head>
	    <meta charset="utf-8">
	    <title>NodeStorageExplorer</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <meta name="description" content="">
	    <meta name="author" content="">

      <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
      <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">
      <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
      <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap-transition.js"></script>
      <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap-modal.js"></script>
      <script src="http://documentcloud.github.com/underscore/underscore.js"></script>
      <script src="http://documentcloud.github.com/backbone/backbone.js"></script>
      <script src="http://cloud.github.com/downloads/wycats/handlebars.js/handlebars-1.0.0.beta.6.js"></script>
            

      <style>
	      body {
	        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
	      }
	    </style>

		  
	    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
	    <!--[if lt IE 9]>
	      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	    <![endif]-->

  	</head>

  	<body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">NodeStorageExplorer</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="#login">Login</a></li>
              <li><a href="#tables">Tables</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
      <div id="content"></div>
    </div> <!-- /container -->


    <div class="modal" id="loginModal" style="display:none">
      <div class="modal-header">
        <h3>Enter your storage account and key</h3>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="control-group">
            <label class="control-label" for="storageAccount">Storage Account</label>
            <div class="controls">
              <input type="text" id="storageAccount" class="input-x-large" style="margin-bottom: 0px;">
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="storageKey">Storage Key</label>
            <div class="controls">
              <input type="password" id="storageKey" class="input-x-large" style="margin-bottom: 0px;">
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="storageKey"></label>
            <div class="controls">
              <a href="javascript:void(0);" class="btn btn-primary" onclick="Two10.login();">Login</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script id="table-template" type="text/x-handlebars-template">
      <h2>Table Storage</h2>
      <div class="row">
        <div class="span2" id="tableList">

        </div>
        <div class="span10" id="entities">

        </div>
      </div>
    </script>

    <script id="tableList-template" type="text/x-handlebars-template">
      <ul class="unstyled">
        {{#each tables}}
        <li><a href="#tables/{{this.TableName}}">{{this.TableName}}</a></li>
        {{/each}}
      </ul>
    </script>

    <script id="entity-template" type="text/x-handlebars-template">
      <table class="table table-striped table-bordered table-condensed">
        {{#entity entities}}
          {{this}}
        {{/entity}}
      </table>
    </script>

    <script id="loading-template" type="text/x-handlebars-template">
      <span class="label label-info">Loading...</span>
    </script>

    <script>
this.Two10 = new function() {
  
  this.account = "two10ra"

  this.key = "dmIMUY1mg/qPeOgGmCkO333L26cNcnUA1uMcSSOFMB3cB8LkdDkh02RaYTPLBL8qMqnqazqd6uMxI2bJJEnj0g=="
  
  this.login = function() {
    Two10.account = $("#storageAccount").val();
    Two10.key = $("#storageKey").val();
    $('#loginModal').modal('hide');
  }

  this.query = function(path, callback){
    console.log("querying " + path)    
    jQuery.ajax(path, {
      cache:false,
      headers: { account: Two10.account, key: Two10.key},
      success : callback
    });
  }

  this.view = function(template, data, target){
    console.log("running view onto " + target);
    console.log(data);
    $(target).html(template(data));
  }



  this.Templates = new function(){

    this.tableTemplate = Handlebars.compile($("#table-template").html()),
    this.tableListTemplate = Handlebars.compile($("#tableList-template").html()),
    this.entityTemplate = Handlebars.compile($("#entity-template").html())
    this.loadingTemplate = Handlebars.compile($("#loading-template").html())

  }
}


function compareObjects(obj1, obj2){
  for (var prop in obj1){
    if (!obj2[prop]){
      return false;
    }
  }
  for (var prop in obj2){
    if (!obj1[prop]){
      return false;
    }
  }
  return true;
}


Handlebars.registerHelper('entity', function(items, options) {
  var out = "";
  var lastitem;
  for (var i = 0; i < items.length; i++){

    var item = items[i];
    if (!lastitem || !compareObjects(lastitem, item)){
      out = out + "<tr>";
      for(var prop in item){
        if (prop != "id" && prop != "link" && prop != "etag") {
          out = out + "<th>" + prop + "</th>"
        }
      }
      out = out + "</tr>";      
    }

    out = out + "<tr>";
    for(var prop in item){
      if (prop != "id" && prop != "link" && prop != "etag") {
        out = out + "<td>" + item[prop] + "</td>"
      }
    }
    out = out + "</tr>";
    lastitem = item;
  }
  
  return out;
});


var AppRouter = Backbone.Router.extend({
  routes: {
    "login" : "login",
    "tables" : "tables",
    "tables/*table" : "table",
    "*actions": "defaultRoute"
  },
  login:function(){
    $('#loginModal').modal({backdrop:true});
  },
  tables: function(){
    Two10.view(Two10.Templates.tableTemplate, {}, "#content");
    Two10.view(Two10.Templates.loadingTemplate, {}, "#tableList");    
    Two10.query("/tables/", function(data){
      Two10.view(Two10.Templates.tableListTemplate, {tables:data}, "#tableList");
    });
  },
  table: function(table){
    Two10.view(Two10.Templates.loadingTemplate, {}, "#entities");
    Two10.query("/tables/" + table, function(data){
      Two10.view(Two10.Templates.entityTemplate, {entities:data}, "#entities");
    });
  },
  defaultRoute: function( actions ){
    alert( actions ); 
  }
});
var app_router = new AppRouter;
Backbone.history.start();


    </script>


	</body>
</html>



